{% extends 'base.html' %}

{% block content %}
<div class="container main-content">
  <h1 class="edit-title">Edit Recipe: {{ recipe.name }}</h1>

  <form method="POST" enctype="multipart/form-data" class="edit-recipe-form">
    {% csrf_token %}

    <div class="form-columns">
      <div class="recipe-column">
        <div class="form-section">
          <div class="form-group">
            <label for="{{ form.name.id_for_label }}" class="form-label">{{ form.name.label }}</label>
            {{ form.name }}
          </div>
          <div class="form-group">
            <label for="{{ form.description.id_for_label }}" class="form-label">{{ form.description.label }}</label>
            {{ form.description }}
          </div>
          <div class="form-group">
            <label for="{{ form.prep_time.id_for_label }}" class="form-label">{{ form.prep_time.label }}</label>
            {{ form.prep_time }}
          </div>
          <div class="form-group">
            <label for="{{ form.cook_time.id_for_label }}" class="form-label">{{ form.cook_time.label }}</label>
            {{ form.cook_time }}
          </div>
          <div class="form-group">
            <label for="{{ form.serving_size.id_for_label }}" class="form-label">{{ form.serving_size.label }}</label>
            {{ form.serving_size }}
          </div>
          <div class="form-group">
            <label for="{{ form.category.id_for_label }}" class="form-label">{{ form.category.label }}</label>
            {{ form.category }}
          </div>
          <div class="form-group">
            <label for="{{ form.difficulty.id_for_label }}" class="form-label">{{ form.difficulty.label }}</label>
            {{ form.difficulty }}
          </div>
          <div class="form-group">
            <label for="{{ form.cuisine.id_for_label }}" class="form-label">{{ form.cuisine.label }}</label>
            {{ form.cuisine }}
          </div>
          <div class="form-group">
            <label for="{{ form.instructions.id_for_label }}" class="form-label">{{ form.instructions.label }}</label>
            {{ form.instructions }}
          </div>
        </div>
      </div>

      <div class="ingredients-column">
        <h2 class="ingredient-title">Edit Ingredients</h2>
        
        <div id="ingredient-formset" class="ingredient-formset">
          {{ ingredient_forms.management_form }}
          
          {% for form in ingredient_forms %}
            <div class="ingredient-form">
              <div class="form-group">
                <label for="{{ form.name.id_for_label }}" class="form-label">{{ form.name.label }}</label>
                {{ form.name }}
              </div>
              <div class="form-group">
                <label for="{{ form.quantity.id_for_label }}" class="form-label">{{ form.quantity.label }}</label>
                {{ form.quantity }}
              </div>
              {% if form.instance.pk %}
                <div class="form-group delete-toggle">
                  {{ form.DELETE }} <label>Delete</label>
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>

        <button type="button" id="add-ingredient" class="add-ingredient-btn">+ Add Ingredient</button>
      </div>
    </div>

    <button type="submit" class="submit-btn">Save Changes</button>
  </form>
</div>

<div id="empty-form-template" style="display: none;">
  <div class="ingredient-form">
    <div class="form-group">
      <label for="id_ingredient_name" class="form-label">Ingredient Name:</label>
      <input type="text" name="ingredient_set-__prefix__-name" id="id_ingredient_set-__prefix__-name" required class="input-field">
    </div>
    <div class="form-group">
      <label for="id_ingredient_quantity" class="form-label">Ingredient Quantity:</label>
      <input type="text" name="ingredient_set-__prefix__-quantity" id="id_ingredient_set-__prefix__-quantity" required class="input-field">
    </div>
    <input type="hidden" name="ingredient_set-__prefix__-id" id="id_ingredient_set-__prefix__-id">
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const addButton = document.getElementById('add-ingredient');
    const formsetDiv = document.getElementById('ingredient-formset');
    const totalFormsInput = document.querySelector('[name$="-TOTAL_FORMS"]');
    const emptyFormTemplate = document.getElementById('empty-form-template').innerHTML;

    addButton.addEventListener('click', function () {
      console.log('Add Ingredient button clicked');

      const formCount = parseInt(totalFormsInput.value, 10);
      
      if (isNaN(formCount)) {
        console.error('Invalid form count');
        return;
      }

      const newFormHtml = emptyFormTemplate.replace(/__prefix__/g, formCount);
      
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = newFormHtml;
      
      formsetDiv.appendChild(tempDiv.firstElementChild);

      totalFormsInput.value = formCount + 1;
    });
  });

</script>
{% endblock %}
